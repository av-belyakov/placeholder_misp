# Readme

Сервис 'placeholder_MISP' выполняет формирование и загрузку в MISP объектов типа case и alert, полученных от TheHive v4 через брокер сообщений NATS.

### Типы конфигурационных файлов

- config.yml общий конфигурационный файл
- config_dev.yml конфигурационный файл используемый для тестов при разработке
- config_prod.yml конфигурационный файл применяемый в продуктовом режиме

### Переменные окружения

Основная переменная окружения для данного приложения - GO_PHMISP_MAIN. На основании значения этой переменной принимается решение какой из конфигурационных файлов config_dev.yml или config_prod.yml использовать. При GO_PHMISP_MAIN=development будет использоваться config_dev.yml, во всех остальных случаях, в том числе и при отсутствии переменной окружения GO_PHMISP_MAIN будет использоваться конфигурационный файл config_prod.yml. Перечень переменных окружения которые можно использовать для настройки приложения:

1. Подключение к MISP:

- GO_PHMISP_MHOST
- GO_PHMISP_MAUTH

2. Подключение к NATS:

- GO_PHMISP_NHOST - ip или доменное имя
- GO_PHMISP_NPORT - сетевой порт
- GO_PHMISP_NCACHETTL - данный параметр должен содержать время жизни записи
  кэша, по истечение которого запись автоматически удаляется, значение задается в секундах в диапазоне от 10 до 86400 секунд
- GO_PHMISP_NSUBLISTENERCASE - канал для приема из него информации по case
- GO_PHMISP_NSUBSENDERCOMMAND - канал для передачи команд которые нужно выполнить на TheHive

3. Подключение к Sqlite3:

- GO_PHMISP_SQLITE3PATH

4. Место расположения и наименования файла правил:

- GO_PHMISP_RULES_DIR
- GO_PHMISP_RULES_FILE

5. Настройки доступа к БД в которую будут записыватся логи

- GO_PHMISP_DBWLOGHOST - доменное имя или ip БД
- GO_PHMISP_DBWLOGPORT - порт БД
- GO_PHMISP_DBWLOGNAME - наименование БД (при необходимости)
- GO_PHMISP_DBWLOGSTORAGENAME - наименование объекта хранения логов (таблица, документ, индекс и т.д. зависит от типа БД)
- GO_PHMISP_DBWLOGUSER - пользователь БД
- GO_PHMISP_DBWLOGPASSWD - пароль для доступа к БД

Настройки логирования данных в БД не являются обязательными и необходимы только если пользователь приложения желает хранить логи в базе данных.

Приоритет значений заданных через переменные окружения выше чем значений полученных из конфигурационных файлов. Таким образом можно осуществлять гибкую временную настройку приложения.

### Сервис выполняет сделующие действия:

1.  Получает, через API MISP, список всех пользователей MISP с их авторизационным ключем. Это нужно для того что бы загружать JSON сообщения в форматах MISP от имени любого пользователя. Имя пользователя кейса TheHive берется из 'event.object.owner'. Если имени пользователя, полученного из TheHive, нет в MISP то такой пользователь автоматически создается.

2.  Осуществляет соединение с NATS.

3.  Получает кейсы от TheHive в формате JSON.

4.  Выполняет их разбор и анализ на основе правил. Есть два типа правил для анализа принятых кейсов, это правила разрешающие дальнейшую передачу кейса в MISP и правила, при совпадении параметров которых выполняется модификация данных в кейсе.

5.  Из кейсов, пропущенных для отправки MISP, формируются JSON сообщения на основе MISP форматов типа Events и Attributes. Данные сообщения загружаются через API MISP от имени пользователя создавшего кейс в TheHive (путь в JSON от TheHive 'event.object.owner')

Тип Attributes формата MISP формируется по следующим условиям:

- если, свойство observables.tags содержит значение вида misp:Attribution="whois-registrar", то осуществляется разбор данной строки, где значение Attribution добавляется в AttributesMispFormat.Category, а значение whois-registrar в AttributesMispFormat.Type;
- если, свойство observables.dataType содержит одно из свойств определенного перечня значений, то свойства AttributesMispFormat.Category и AttributesMispFormat.Type будут заполненны на основании найденного значения в observables.dataType:
- если, observables.tags содержит значение отличное от знаяения вида misp:Attribution="whois-registrar", но которое совпадает со значением в коде
  приложения, например, одно из подобных значений это type:<значение> которое может совпадать или быть схожем со содержимым в observables.dataType, то это значение добавляется в AttributesMispFormat.ObjectRelation.

6.  После успешной отправки в MISP сформированных сообщений в TheHive отправляется два JSON сообщения. Сообщение с командой на установку тега в обработанном кейсе TheHive:

```json
{
  "service": "MISP",
  "command": "add_case_tag",
  "root_id": "%s",
  "case_id": "%s",
  "value": "Webhook: send=\"MISP_TEST\""
}
```

И JSON сообщение, для TheHive, содержащее идентификационный номер события полученного от MISP:

```json
{
  "service": "MISP",
  "command": "set_case_custom_field",
  "root_id": "<rootId обработанного кейса>",
  "field_name": "misp-event-id.string",
  "value": "<идентификатор события MISP>"
}
```
